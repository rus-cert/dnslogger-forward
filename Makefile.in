srcdir = @srcdir@
INSTALL = @INSTALL@

prefix = @prefix@
exec_prefix = @exec_prefix@
bindir = @bindir@
libdir = @libdir@
mandir = @mandir@
man1dir = $(mandir)/man1
exeext = @EXEEXT@

CC = @CC@
CFLAGS = @CFLAGS@ @WARN_CFLAGS@

named_version = @PACKAGE_NAME@-@PACKAGE_VERSION@

INCLUDES = -I. -I$(srcdir)/src
LIBS = @LIBS@

SRC_C_FILES := $(patsubst $(srcdir)/src/%,%,$(wildcard $(srcdir)/src/*.c))
DEP_H_FILES := config.h $(wildcard $(srcdir)/src/*.h)
INVENTORY := COPYING Makefile.in README doc/dnslogger-forward.8 \
	config.guess config.sub configure.ac install-sh \
	$(patsubst %,src/%,$(SRC_C_FILES)) \
	$(patsubst $(srcdir)/src/%,src/%,$(wildcard $(srcdir)/src/*.h)) \
	$(patsubst $(srcdir)/testsuite/%,testsuite/%,$(wildcard $(srcdir)/testsuite/*.in)) \
	$(patsubst $(srcdir)/testsuite/%,testsuite/%,$(wildcard $(srcdir)/testsuite/*.expected)) \
	testsuite/generate.pl
DISTFILES_GENERATED = config.h.in stamp-h.in configure

src_obj_files := $(patsubst %.c, src/%.o, $(SRC_C_FILES))

all : dnslogger-forward$(exeext)

install:
	$(INSTALL) -m 755 dnslogger-forward$(exeext) $(DESTDIR)$(bindir)/dnslogger-forward$(exeext)
	$(INSTALL) -m 644 $(srcdir)/doc/dnslogger-forward$.8 $(DESTDIR)$(man1dir)/dnslogger-forward.8

dist:
	mkdir $(named_version)
	tar cf - -C $(srcdir) $(INVENTORY) $(DISTFILES_GENERATED) \
		| tar xf - -C $(named_version)
	cd $(named_version)/ && touch $(DISTFILES_GENERATED)
	GZIP=--best tar czf $(named_version).tar.gz $(named_version)/
	rm -rf $(named_version)

clean :
	-rm dnslogger-forward
	-rm src/*.o
	-rm testsuite/*.out testsuite/FAILED
	-rm stamp-dir

distclean : clean
	-rm config.log config.status config.h stamp-h Makefile

dnslogger-forward$(exeext) : stamp-dir $(src_obj_files) $(lib_obj_files)
	$(CC) -o $@ $(src_obj_files) $(lib_obj_files) $(LIBS)

stamp-dir :
	-mkdir src
	-mkdir testsuite
	echo timestamp > stamp-dir

src/%.o : $(srcdir)/src/%.c $(DEP_H_FILES)
	$(CC) $(CFLAGS) $(INCLUDES) -c -o $@ $<

.PHONY : test test-diff

test :
	@rm testsuite/FAILED testsuite/*.out 2> /dev/null || true
	@for x in $(patsubst $(srcdir)/testsuite/%.in,%,$(wildcard $(srcdir)/testsuite/default_*.in)) ; do \
		$(VALGRIND) ./dnslogger-forward$(exeext) -T \
			< $(srcdir)/testsuite/$$x.in \
			> testsuite/$$x.out \
			2>&1 ; \
		if cmp $(srcdir)/testsuite/$$x.expected testsuite/$$x.out >/dev/null ; then \
			: ; \
		else \
			echo "FAILED test case: $$x" ; touch testsuite/FAILED ; \
		fi \
	done || true
	@for x in $(patsubst $(srcdir)/testsuite/%.in,%,$(wildcard $(srcdir)/testsuite/A_*.in)) ; do \
		$(VALGRIND) ./dnslogger-forward$(exeext) -A -T \
			< $(srcdir)/testsuite/$$x.in \
			> testsuite/$$x.out \
			2>&1 ; \
		if cmp $(srcdir)/testsuite/$$x.expected testsuite/$$x.out >/dev/null ; then \
			: ; \
		else \
			echo "FAILED test case: $$x" ; touch testsuite/FAILED ; \
		fi \
	done || true
	@for x in $(patsubst $(srcdir)/testsuite/%.in,%,$(wildcard $(srcdir)/testsuite/D_*.in)) ; do \
		$(VALGRIND) ./dnslogger-forward$(exeext) -D -T \
			< $(srcdir)/testsuite/$$x.in \
			> testsuite/$$x.out \
			2>&1 ; \
		if cmp $(srcdir)/testsuite/$$x.expected testsuite/$$x.out >/dev/null ; then \
			: ; \
		else \
			echo "FAILED test case: $$x" ; touch testsuite/FAILED ; \
		fi \
	done || true
	@if test -e testsuite/FAILED ; then \
		echo "There were failed test cases." ; exit 1 ; \
	else \
		echo "All tests passed." ; \
	fi || true

test-diff :
	@for x in $(patsubst $(srcdir)/testsuite/%.in,%,$(wildcard $(srcdir)/testsuite/*.in)) ; do \
		diff -u $(srcdir)/testsuite/$$x.expected testsuite/$$x.out ; \
	done || true


# Automatic regeneration of files generated by the autoconf machinery.

# autoheader might not change config.h.in, so touch a stamp file.
$(srcdir)/config.h.in: $(srcdir)/stamp-h.in
$(srcdir)/stamp-h.in: $(srcdir)/configure.ac
	cd $(srcdir) && autoheader
	echo timestamp > $(srcdir)/stamp-h.in

$(srcdir)/config.h: stamp-h
stamp-h: $(srcdir)/config.h.in config.status
	./config.status

Makefile: $(srcdir)/Makefile.in config.status
	./config.status

config.status: $(srcdir)/configure
	./config.status --recheck
